<?xml version="1.0" encoding="utf-8"?>
<feed xmlns="http://www.w3.org/2005/Atom">

  <title><![CDATA[An Honglei ’s Blog]]></title>
  <link href="www.anhaoker.com/atom.xml" rel="self"/>
  <link href="www.anhaoker.com/"/>
  <updated>2018-01-31T22:16:32+08:00</updated>
  <id>www.anhaoker.com/</id>
  <author>
    <name><![CDATA[]]></name>
    
  </author>
  <generator uri="http://www.mweb.im/">MWeb</generator>
  
  <entry>
    <title type="html"><![CDATA[MySQL 5.7 版本新特性]]></title>
    <link href="www.anhaoker.com/15174039905214.html"/>
    <updated>2018-01-31T21:06:30+08:00</updated>
    <id>www.anhaoker.com/15174039905214.html</id>
    <content type="html"><![CDATA[
<p>第1章 MySQL服务功能增强<br/>
第2章 Replication相关增强 <br/>
第3章 InnoDB引擎增强 <br/>
第4章 安全及管理方面增强</p>

<p>参考视频：<a href="https://www.imooc.com/learn/533">https://www.imooc.com/learn/533</a></p>

<span id="more"></span><!-- more -->

<h2 id="toc_0">第1章 MySQL服务功能增强</h2>

<h3 id="toc_1">数据库初始方式的变更</h3>

<p>生产临时root密码、数据目录、日志信息等</p>

<pre><code>#Mysql 5.7之前的初始化
mysql_install_db  --datadir=/data/mysql/3306/data  --user=mysql --basedir=/usr/local/mysql

#Mysql 5.7之后的初始化
mysqld --initialize --user=mysql --basedir=/usr/local/mysql --datadir=/data/mysql/3306/data

</code></pre>

<h3 id="toc_2">支持为表增加计算列</h3>

<p>当表中有一列的数据为其他列的之间通过计算而求得的值，此列则为计算列</p>

<p>计算列分为：虚拟列（virtual——没有被存储在磁盘中）和存储列（stored——会被存储在磁盘中）</p>

<p>在create table 及 alter table 语名中支持增加计算列的方式：<br/>
col_name data_type[genrated always] as (expression) [virtual | stored ] [ unique [key]] [ comment comment] [ [not] null ] [[primary] key]</p>

<pre><code>#Mysql 5.7 之前——需要通过触发器或视图实现相关的功能（缺点：会影响性能）

root@localhost:test 09:26:51 &gt;create table t(id int auto_increment not null,c1 int,c2 int,c3 int,primary key (id));
Query OK, 0 rows affected (0.03 sec)

root@localhost:test 09:27:51 &gt;show create table t;
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t     | CREATE TABLE `t` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `c1` int(11) DEFAULT NULL,
  `c2` int(11) DEFAULT NULL,
  `c3` int(11) DEFAULT NULL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
+-------+-------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

**创建插入触发器**
root@localhost:test 09:28:23 &gt;create trigger inst_t before insert on t for each row each row set new.c3=new.c1+new.c2;
ERROR 1064 (42000): You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near &#39;each row set new.c3=new.c1+new.c2&#39; at line 1
root@localhost:test 09:30:42 &gt;create trigger inst_t before insert on t for each row set new.c3=new.c1+new.c2;         
Query OK, 0 rows affected (0.02 sec)

root@localhost:test 09:35:16 &gt;show triggers;
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
| Trigger       | Event  | Table   | Statement                                                                                                             | Timing | Created                | sql_mode                                                                                                               | Definer        | character_set_client | collation_connection | Database Collation |
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
| deleteorder   | DELETE | orders  | begin insert into arhive_orders(order_num,order_date,cust_id) values(old.order_num, old.order_date, old.cust_id); end | BEFORE | 2017-12-27 22:32:46.35 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| inst_t        | INSERT | t       | set new.c3=new.c1+new.c2                                                                                              | BEFORE | 2018-01-31 21:35:16.21 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| insertevendor | INSERT | vendors | set new.vend_state = upper(new.vend_state)                                                                            | BEFORE | 2017-12-27 22:36:37.96 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| updatevendor  | UPDATE | vendors | set new.vend_state = upper(new.vend_state)                                                                            | BEFORE | 2017-12-27 22:34:53.05 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
4 rows in set (0.00 sec)

root@localhost:test 09:35:45 &gt;insert into t(c1,c2) values(1,2);
Query OK, 1 row affected (0.02 sec)

root@localhost:test 09:36:52 &gt;select * from t;
+----+------+------+------+
| id | c1   | c2   | c3   |
+----+------+------+------+
|  1 |    1 |    2 |    3 |
+----+------+------+------+
1 row in set (0.00 sec)

**创建更新触发器**——用于已有值的变化
root@localhost:test 09:37:02 &gt;create trigger upd_t before update on t for each row set new.c3=new.c1+new.c2;
Query OK, 0 rows affected (0.01 sec)

root@localhost:test 09:39:35 &gt;show triggers;
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
| Trigger       | Event  | Table   | Statement                                                                                                             | Timing | Created                | sql_mode                                                                                                               | Definer        | character_set_client | collation_connection | Database Collation |
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
| deleteorder   | DELETE | orders  | begin insert into arhive_orders(order_num,order_date,cust_id) values(old.order_num, old.order_date, old.cust_id); end | BEFORE | 2017-12-27 22:32:46.35 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| inst_t        | INSERT | t       | set new.c3=new.c1+new.c2                                                                                              | BEFORE | 2018-01-31 21:35:16.21 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| upd_t         | UPDATE | t       | set new.c3=new.c1+new.c2                                                                                              | BEFORE | 2018-01-31 21:39:35.78 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| insertevendor | INSERT | vendors | set new.vend_state = upper(new.vend_state)                                                                            | BEFORE | 2017-12-27 22:36:37.96 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
| updatevendor  | UPDATE | vendors | set new.vend_state = upper(new.vend_state)                                                                            | BEFORE | 2017-12-27 22:34:53.05 | STRICT_TRANS_TABLES,NO_ZERO_IN_DATE,NO_ZERO_DATE,ERROR_FOR_DIVISION_BY_ZERO,NO_AUTO_CREATE_USER,NO_ENGINE_SUBSTITUTION | root@localhost | utf8                 | utf8_general_ci      | utf8_general_ci    |
+---------------+--------+---------+-----------------------------------------------------------------------------------------------------------------------+--------+------------------------+------------------------------------------------------------------------------------------------------------------------+----------------+----------------------+----------------------+--------------------+
5 rows in set (0.00 sec)

root@localhost:test 09:39:49 &gt;update t set c1=5 where id = 1;
Query OK, 1 row affected (0.01 sec)
Rows matched: 1  Changed: 1  Warnings: 0

root@localhost:test 09:40:37 &gt;select * from t;
+----+------+------+------+
| id | c1   | c2   | c3   |
+----+------+------+------+
|  1 |    5 |    2 |    7 |
+----+------+------+------+
1 row in set (0.00 sec)

**使用视图的方式**——可以达到计算列的目的
root@localhost:test 09:40:44 &gt;create view vw_t as select id,c1,c2,c1+c2 as c3 from t;
Query OK, 0 rows affected (0.02 sec)

root@localhost:test 09:43:16 &gt;select * from vw_t;
+----+------+------+------+
| id | c1   | c2   | c3   |
+----+------+------+------+
|  1 |    5 |    2 |    7 |
+----+------+------+------+
1 row in set (0.00 sec)


#Mysql 5.7 之后——需要通过触发器实现相关的功能
root@localhost:test 09:43:28 &gt;create table t1 (id int auto_increment not null,c1 int,c2 int,c3 int as (c1+c2),primary key(id));
Query OK, 0 rows affected (0.02 sec)

root@localhost:test 09:53:19 &gt;show create table t1;
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| Table | Create Table                                                                                                                                                                                                                                |
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
| t1    | CREATE TABLE `t1` (
  `id` int(11) NOT NULL AUTO_INCREMENT,
  `c1` int(11) DEFAULT NULL,
  `c2` int(11) DEFAULT NULL,
  `c3` int(11) GENERATED ALWAYS AS ((`c1` + `c2`)) VIRTUAL,
  PRIMARY KEY (`id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
+-------+---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

root@localhost:test 09:53:55 &gt;insert into t1(c1,c2) values(1,2);
Query OK, 1 row affected (0.00 sec)

root@localhost:test 09:54:52 &gt;select * from t1;
+----+------+------+------+
| id | c1   | c2   | c3   |
+----+------+------+------+
|  1 |    1 |    2 |    3 |
+----+------+------+------+
1 row in set (0.00 sec)

root@localhost:test 09:55:01 &gt;update t1 set c1=5 where id = 1;
Query OK, 1 row affected (0.00 sec)
Rows matched: 1  Changed: 1  Warnings: 0

root@localhost:test 09:55:39 &gt;select * from t1;
+----+------+------+------+
| id | c1   | c2   | c3   |
+----+------+------+------+
|  1 |    5 |    2 |    7 |
+----+------+------+------+
1 row in set (0.00 sec)

</code></pre>

<h3 id="toc_3">引入json列类型及相关函数</h3>

<p>在MySQL中的json分为：json数组和json对象</p>

<pre><code>#MySQL 5.7 之前
**只能在varchar或是text等字符类型中列存储json类型的字符串，并通过程序解析使用json字符串。**



#MySQL 5.7 之后
**增加了json列类型（新的数据类型及自动验证json类型格式）及以json开头的相关处理函数，如json_type(),json_object(),json_merge()等。**

**json数组示例**——中括号
root@localhost:test 09:55:58 &gt;select json_array(&#39;a&#39;,&#39;b&#39;,now());
+------------------------------------------+
| json_array(&#39;a&#39;,&#39;b&#39;,now())                |
+------------------------------------------+
| [&quot;a&quot;, &quot;b&quot;, &quot;2018-01-31 22:09:35.000000&quot;] |
+------------------------------------------+
1 row in set (0.00 sec)

**json对象示例**——大括号
root@localhost:test 10:09:35 &gt;select json_object(&#39;key1&#39;,1,&#39;key2&#39;,2);
+--------------------------------+
| json_object(&#39;key1&#39;,1,&#39;key2&#39;,2) |
+--------------------------------+
| {&quot;key1&quot;: 1, &quot;key2&quot;: 2}         |
+--------------------------------+
1 row in set (0.00 sec)

**创建json表**
root@localhost:test 10:10:11 &gt;create table t2 (jdoc json);
Query OK, 0 rows affected (0.02 sec)

root@localhost:test 10:12:35 &gt;show create table t2;
+-------+-------------------------------------------------------------------------------------+
| Table | Create Table                                                                        |
+-------+-------------------------------------------------------------------------------------+
| t2    | CREATE TABLE `t2` (
  `jdoc` json DEFAULT NULL
) ENGINE=InnoDB DEFAULT CHARSET=utf8 |
+-------+-------------------------------------------------------------------------------------+
1 row in set (0.00 sec)

root@localhost:test 10:12:47 &gt;insert into t2(jdoc) values(json_array(&#39;a&#39;,&#39;b&#39;,now()));
Query OK, 1 row affected (0.00 sec)

root@localhost:test 10:14:38 &gt;select * from t2;
+------------------------------------------+
| jdoc                                     |
+------------------------------------------+
| [&quot;a&quot;, &quot;b&quot;, &quot;2018-01-31 22:14:38.000000&quot;] |
+------------------------------------------+
1 row in set (0.00 sec)


</code></pre>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mysql 5.7 主从复制]]></title>
    <link href="www.anhaoker.com/15174037792214.html"/>
    <updated>2018-01-31T21:02:59+08:00</updated>
    <id>www.anhaoker.com/15174037792214.html</id>
    <content type="html"><![CDATA[

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[Mysql基础知识]]></title>
    <link href="www.anhaoker.com/15173854634491.html"/>
    <updated>2018-01-31T15:57:43+08:00</updated>
    <id>www.anhaoker.com/15173854634491.html</id>
    <content type="html"><![CDATA[
<p>安装、维护、常用命令等</p>

<h2 id="toc_0">安装</h2>

<h2 id="toc_1">维护</h2>

]]></content>
  </entry>
  
  <entry>
    <title type="html"><![CDATA[MWEB基础教程——静态博客]]></title>
    <link href="www.anhaoker.com/15171178933552.html"/>
    <updated>2018-01-28T13:38:13+08:00</updated>
    <id>www.anhaoker.com/15171178933552.html</id>
    <content type="html"><![CDATA[
<p>MWEG+GITHUB<br/>
&lt;!-- more --&gt;</p>

<p><a href="http://zh.mweb.im/themes.html">http://zh.mweb.im/themes.html</a></p>

]]></content>
  </entry>
  
</feed>
