<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  Alertmanager报警模块 - An Honglei ’s Blog
  
  </title>
 <meta name="description" content="学习是痛并快乐着！！！">
 <link href="atom.xml" rel="alternate" title="An Honglei ’s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">An Honglei ’s Blog</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; An Honglei ’s Blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>监控</label></li>

          
            <li><a title="IPMI-DELL" href="15287735246134.html">IPMI-DELL</a></li>
          
            <li><a title="VM WARE esxi" href="15286986347471.html">VM WARE esxi</a></li>
          
            <li><a title="IO监控" href="15284429017864.html">IO监控</a></li>
          
            <li><a title="zookeeper" href="15284264486830.html">zookeeper</a></li>
          
            <li><a title="docker" href="15284264396270.html">docker</a></li>
          
            <li><a title="redis" href="15284264338352.html">redis</a></li>
          
            <li><a title="mongodb" href="15284264265436.html">mongodb</a></li>
          
            <li><a title="mysql" href="15284264221433.html">mysql</a></li>
          
            <li><a title="nginx" href="15284264147825.html">nginx</a></li>
          
            <li><a title="JVM" href="15284264028937.html">JVM</a></li>
          
            <li><a title="配置报警-邮件和微信" href="15284261636485.html">配置报警-邮件和微信</a></li>
          
            <li><a title="自动发现设置" href="15284261175013.html">自动发现设置</a></li>
          
            <li><a title="Alertmanager报警模块" href="15270467833243.html">Alertmanager报警模块</a></li>
          
            <li><a title="运维监控工作规划" href="15264350522088.html">运维监控工作规划</a></li>
          
            <li><a title="# Prometheus 简介及安装" href="15258517853636.html"># Prometheus 简介及安装</a></li>
          
            <li><a title="部署 Prometheus 基础环境" href="15258308100903.html">部署 Prometheus 基础环境</a></li>
          
            <li><a title="prometheus监控调研方案" href="15257584688763.html">prometheus监控调研方案</a></li>
          
            <li><a title="监控迁移过程注意事项整理" href="15253278795397.html">监控迁移过程注意事项整理</a></li>
          
            <li><a title="zabbix3.2升级到3.4" href="15246459775922.html">zabbix3.2升级到3.4</a></li>
          
            <li><a title="zabbix3.2/3.4 部署安装" href="15246196912882.html">zabbix3.2/3.4 部署安装</a></li>
          
            <li><a title="天兔" href="15243054043731.html">天兔</a></li>
          

      
        <li class="divider"></li>
        <li><label>Python</label></li>

          
            <li><a title="基础知识练习" href="15221590998154.html">基础知识练习</a></li>
          
            <li><a title="python 基础" href="15214289229123.html">python 基础</a></li>
          

      
        <li class="divider"></li>
        <li><label>基础整理</label></li>

          
            <li><a title="LINUX 快捷键整理" href="15306935051951.html">LINUX 快捷键整理</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>监控</span></li>
                        
                          <li><a title="IPMI-DELL" href="15287735246134.html">IPMI-DELL</a></li>
                        
                          <li><a title="VM WARE esxi" href="15286986347471.html">VM WARE esxi</a></li>
                        
                          <li><a title="IO监控" href="15284429017864.html">IO监控</a></li>
                        
                          <li><a title="zookeeper" href="15284264486830.html">zookeeper</a></li>
                        
                          <li><a title="docker" href="15284264396270.html">docker</a></li>
                        
                          <li><a title="redis" href="15284264338352.html">redis</a></li>
                        
                          <li><a title="mongodb" href="15284264265436.html">mongodb</a></li>
                        
                          <li><a title="mysql" href="15284264221433.html">mysql</a></li>
                        
                          <li><a title="nginx" href="15284264147825.html">nginx</a></li>
                        
                          <li><a title="JVM" href="15284264028937.html">JVM</a></li>
                        
                          <li><a title="配置报警-邮件和微信" href="15284261636485.html">配置报警-邮件和微信</a></li>
                        
                          <li><a title="自动发现设置" href="15284261175013.html">自动发现设置</a></li>
                        
                          <li><a title="Alertmanager报警模块" href="15270467833243.html">Alertmanager报警模块</a></li>
                        
                          <li><a title="运维监控工作规划" href="15264350522088.html">运维监控工作规划</a></li>
                        
                          <li><a title="# Prometheus 简介及安装" href="15258517853636.html"># Prometheus 简介及安装</a></li>
                        
                          <li><a title="部署 Prometheus 基础环境" href="15258308100903.html">部署 Prometheus 基础环境</a></li>
                        
                          <li><a title="prometheus监控调研方案" href="15257584688763.html">prometheus监控调研方案</a></li>
                        
                          <li><a title="监控迁移过程注意事项整理" href="15253278795397.html">监控迁移过程注意事项整理</a></li>
                        
                          <li><a title="zabbix3.2升级到3.4" href="15246459775922.html">zabbix3.2升级到3.4</a></li>
                        
                          <li><a title="zabbix3.2/3.4 部署安装" href="15246196912882.html">zabbix3.2/3.4 部署安装</a></li>
                        
                          <li><a title="天兔" href="15243054043731.html">天兔</a></li>
                        

                    
                      <li class="side-title"><span>Python</span></li>
                        
                          <li><a title="基础知识练习" href="15221590998154.html">基础知识练习</a></li>
                        
                          <li><a title="python 基础" href="15214289229123.html">python 基础</a></li>
                        

                    
                      <li class="side-title"><span>基础整理</span></li>
                        
                          <li><a title="LINUX 快捷键整理" href="15306935051951.html">LINUX 快捷键整理</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1>Alertmanager报警模块</h1>

<pre><code>Overview
Alertmanager与Prometheus是相互分离的两个部分。Prometheus服务器根据报警规则将警报发送给Alertmanager，然后Alertmanager将silencing、inhibition、aggregation等消息通过电子邮件、PaperDuty和HipChat发送通知。

设置警报和通知的主要步骤：

安装配置Alertmanager
配置Prometheus通过-alertmanager.url标志与Alertmanager通信
在Prometheus中创建告警规则
Alertmanager简介及机制
Alertmanager处理由类似Prometheus服务器等客户端发来的警报，之后需要删除重复、分组，并将它们通过路由发送到正确的接收器，比如电子邮件、Slack等。Alertmanager还支持沉默和警报抑制的机制。

分组
分组是指当出现问题时，Alertmanager会收到一个单一的通知，而当系统宕机时，很有可能成百上千的警报会同时生成，这种机制在较大的中断中特别有用。

例如，当数十或数百个服务的实例在运行，网络发生故障时，有可能服务实例的一半不可达数据库。在告警规则中配置为每一个服务实例都发送警报的话，那么结果是数百警报被发送至Alertmanager。

但是作为用户只想看到单一的报警页面，同时仍然能够清楚的看到哪些实例受到影响，因此，人们通过配置Alertmanager将警报分组打包，并发送一个相对看起来紧凑的通知。

分组警报、警报时间，以及接收警报的receiver是在配置文件中通过路由树配置的。

抑制
抑制是指当警报发出后，停止重复发送由此警报引发其他错误的警报的机制。

例如，当警报被触发，通知整个集群不可达，可以配置Alertmanager忽略由该警报触发而产生的所有其他警报，这可以防止通知数百或数千与此问题不相关的其他警报。

抑制机制可以通过Alertmanager的配置文件来配置。

沉默
沉默是一种简单的特定时间静音提醒的机制。一种沉默是通过匹配器来配置，就像路由树一样。传入的警报会匹配RE，如果匹配，将不会为此警报发送通知。

沉默机制可以通过Alertmanager的Web页面进行配置。

Alertmanager的配置
Alertmanager通过命令行flag和一个配置文件进行配置。命令行flag配置不变的系统参数、配置文件定义的禁止规则、通知路由和通知接收器。

要查看所有可用的命令行flag，运行alertmanager -h。

Alertmanager在运行时加载配置，如果不能很好的形成新的配置，更改将不会被应用，并记录错误。

配置文件
要指定加载的配置文件，需要使用-config.file标志。该文件使用YAML来完成，通过下面的描述来定义。括号内的参数是可选的，对于非列表的参数的值设置为指定的缺省值。

global:
  # ResolveTimeout is the time after which an alert is declared resolved
  # if it has not been updated.
  [ resolve_timeout: &lt;duration&gt; | default = 5m ]

  # The default SMTP From header field.
  [ smtp_from: &lt;tmpl_string&gt; ]
  # The default SMTP smarthost used for sending emails.
  [ smtp_smarthost: &lt;string&gt; ]

  # The API URL to use for Slack notifications.
  [ slack_api_url: &lt;string&gt; ]

  [ pagerduty_url: &lt;string&gt; | default = &quot;https://events.pagerduty.com/generic/2010-04-15/create_event.json&quot; ]
  [ opsgenie_api_host: &lt;string&gt; | default = &quot;https://api.opsgenie.com/&quot; ]

# Files from which custom notification template definitions are read.
# The last component may use a wildcard matcher, e.g. &#39;templates/*.tmpl&#39;.
templates:
  [ - &lt;filepath&gt; ... ]

# The root node of the routing tree.
route: &lt;route&gt;

# A list of notification receivers.
receivers:
  - &lt;receiver&gt; ...

# A list of inhibition rules.
inhibit_rules:
  [ - &lt;inhibit_rule&gt; ... ]

路由 route
路由块定义了路由树及其子节点。如果没有设置的话，子节点的可选配置参数从其父节点继承。

每个警报进入配置的路由树的顶级路径，顶级路径必须匹配所有警报（即没有任何形式的匹配）。然后匹配子节点。如果continue的值设置为false，它在匹配第一个孩子后就停止；如果在子节点匹配，continue的值为true，警报将继续进行后续兄弟姐妹的匹配。如果警报不匹配任何节点的任何子节点（没有匹配的子节点，或不存在），该警报基于当前节点的配置处理。

路由配置格式
[ receiver: &lt;string&gt; ]
[ group_by: &#39;[&#39; &lt;labelname&gt;, ... &#39;]&#39; ]

# Whether an alert should continue matching subsequent sibling nodes.
[ continue: &lt;boolean&gt; | default = false ]

# A set of equality matchers an alert has to fulfill to match the node.
match:
  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]

# A set of regex-matchers an alert has to fulfill to match the node.
match_re:
  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]

# How long to initially wait to send a notification for a group
# of alerts. Allows to wait for an inhibiting alert to arrive or collect
# more initial alerts for the same group. (Usually ~0s to few minutes.)
[ group_wait: &lt;duration&gt; ]

# How long to wait before sending notification about new alerts that are
# in are added to a group of alerts for which an initial notification
# has already been sent. (Usually ~5min or more.)
[ group_interval: &lt;duration&gt; ]

# How long to wait before sending a notification again if it has already
# been sent successfully for an alert. (Usually ~3h or more).
[ repeat_interval: &lt;duration&gt; ]

# Zero or more child routes.
routes:
  [ - &lt;route&gt; ... ]

示例：

# The root route with all parameters, which are inherited by the child
# routes if they are not overwritten.
route:
  receiver: &#39;default-receiver&#39;
  group_wait: 30s
  group_interval: 5m
  repeat_interval: 4h
  group_by: [cluster, alertname]
  # All alerts that do not match the following child routes
  # will remain at the root node and be dispatched to &#39;default-receiver&#39;.
  routes:
  # All alerts with service=mysql or service=cassandra
  # are dispatched to the database pager.
  - receiver: &#39;database-pager&#39;
    group_wait: 10s
    match_re:
      service: mysql|cassandra
  # All alerts with the team=frontend label match this sub-route.
  # They are grouped by product and environment rather than cluster
  # and alertname.
  - receiver: &#39;frontend-pager&#39;
    group_by: [product, environment]
    match:
      team: frontend

抑制规则 inhibit_rule
抑制规则，是存在另一组匹配器匹配的情况下，静音其他被引发警报的规则。这两个警报，必须有一组相同的标签。

抑制配置格式
# Matchers that have to be fulfilled in the alerts to be muted.
target_match:
  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]
target_match_re:
  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]

# Matchers for which one or more alerts have to exist for the
# inhibition to take effect.
source_match:
  [ &lt;labelname&gt;: &lt;labelvalue&gt;, ... ]
source_match_re:
  [ &lt;labelname&gt;: &lt;regex&gt;, ... ]

# Labels that must have an equal value in the source and target
# alert for the inhibition to take effect.
[ equal: &#39;[&#39; &lt;labelname&gt;, ... &#39;]&#39; ]

接收器 receiver
顾名思义，警报接收的配置。

通用配置格式
# The unique name of the receiver.
name: &lt;string&gt;

# Configurations for several notification integrations.
email_configs:
  [ - &lt;email_config&gt;, ... ]
pagerduty_configs:
  [ - &lt;pagerduty_config&gt;, ... ]
slack_config:
  [ - &lt;slack_config&gt;, ... ]
opsgenie_configs:
  [ - &lt;opsgenie_config&gt;, ... ]
webhook_configs:
  [ - &lt;webhook_config&gt;, ... ]

邮件接收器 email_config
# Whether or not to notify about resolved alerts.
[ send_resolved: &lt;boolean&gt; | default = false ]

# The email address to send notifications to.
to: &lt;tmpl_string&gt;
# The sender address.
[ from: &lt;tmpl_string&gt; | default = global.smtp_from ]
# The SMTP host through which emails are sent.
[ smarthost: &lt;string&gt; | default = global.smtp_smarthost ]

# The HTML body of the email notification.
[ html: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;email.default.html&quot; . }}&#39; ] 

# Further headers email header key/value pairs. Overrides any headers
# previously set by the notification implementation.
[ headers: { &lt;string&gt;: &lt;tmpl_string&gt;, ... } ]

Slack接收器 slack_config
# Whether or not to notify about resolved alerts.
[ send_resolved: &lt;boolean&gt; | default = true ]

# The Slack webhook URL.
[ api_url: &lt;string&gt; | default = global.slack_api_url ]

# The channel or user to send notifications to.
channel: &lt;tmpl_string&gt;

# API request data as defined by the Slack webhook API.
[ color: &lt;tmpl_string&gt; | default = &#39;{{ if eq .Status &quot;firing&quot; }}danger{{ else }}good{{ end }}&#39; ]
[ username: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.username&quot; . }}&#39;
[ title: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.title&quot; . }}&#39; ]
[ title_link: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.titlelink&quot; . }}&#39; ]
[ pretext: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.pretext&quot; . }}&#39; ]
[ text: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.text&quot; . }}&#39; ]
[ fallback: &lt;tmpl_string&gt; | default = &#39;{{ template &quot;slack.default.fallback&quot; . }}&#39; ]

Webhook接收器 webhook_config
# Whether or not to notify about resolved alerts.
[ send_resolved: &lt;boolean&gt; | default = true ]

# The endpoint to send HTTP POST requests to.
url: &lt;string&gt;

Alertmanager会使用以下的格式向配置端点发送HTTP POST请求：

{
  &quot;version&quot;: &quot;2&quot;,
  &quot;status&quot;: &quot;&lt;resolved|firing&gt;&quot;,
  &quot;alerts&quot;: [
    {
      &quot;labels&quot;: &lt;object&gt;,
      &quot;annotations&quot;: &lt;object&gt;,
      &quot;startsAt&quot;: &quot;&lt;rfc3339&gt;&quot;,
      &quot;endsAt&quot;: &quot;&lt;rfc3339&gt;&quot;
    },
    ...
  ]
}

报警规则
报警规则允许你定义基于Prometheus语言表达的报警条件，并发送报警通知到外部服务。

定义报警规则
报警规则通过以下格式定义：

ALERT &lt;alert name&gt;
  IF &lt;expression&gt;
  [ FOR &lt;duration&gt; ]
  [ LABELS &lt;label set&gt; ]
  [ ANNOTATIONS &lt;label set&gt; ]

FOR子句使得Prometheus等待第一个传进来的向量元素（例如高HTTP错误的实例），并计数一个警报。如果元素是active，但是没有firing的，就处于pending状态。

LABELS（标签）子句允许指定一组附加的标签附到警报上。现有的任何标签都会被覆盖，标签值可以被模板化。

ANNOTATIONS（注释）子句指定另一组未查明警报实例的标签，它们被用于存储更长的其他信息，例如警报描述或者链接，注释值可以被模板化。

报警规则示例
# Alert for any instance that is unreachable for &gt;5 minutes.
ALERT InstanceDown
  IF up == 0
  FOR 5m
  LABELS { severity = &quot;page&quot; }
  ANNOTATIONS {
    summary = &quot;Instance {{ $labels.instance }} down&quot;,
    description = &quot;{{ $labels.instance }} of job {{ $labels.job }} has been down for more than 5 minutes.&quot;,
  }

# Alert for any instance that have a median request latency &gt;1s.
ALERT APIHighRequestLatency
  IF api_http_request_latencies_second{quantile=&quot;0.5&quot;} &gt; 1
  FOR 1m
  ANNOTATIONS {
    summary = &quot;High request latency on {{ $labels.instance }}&quot;,
    description = &quot;{{ $labels.instance }} has a median request latency above 1s (current value: {{ $value }}s)&quot;,
  }

发送警报通知
Prometheus可以周期性的发送关于警报状态的信息到Alertmanager实例，然后Alertmanager调度来发送正确的通知。该Alertmanager可以通过-alertmanager.url命令行flag来配置。
</code></pre>

<p><a href="https://blog.csdn.net/y_xiao_/article/details/50818451">https://blog.csdn.net/y_xiao_/article/details/50818451</a></p>

<p><a href="https://www.cnblogs.com/iiiiher/p/8277040.html">https://www.cnblogs.com/iiiiher/p/8277040.html</a></p>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15284261175013.html"  title="Previous Post: 自动发现设置">&laquo; 自动发现设置</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15264350522088.html" 
	        title="Next Post: 运维监控工作规划">运维监控工作规划 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15270467833243.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
