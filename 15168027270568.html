
<!DOCTYPE html>
<!--[if IEMobile 7 ]><html class="no-js iem7"><![endif]-->
<!--[if lt IE 9]><html class="no-js lte-ie8"><![endif]-->
<!--[if (gt IE 8)|(gt IEMobile 7)|!(IEMobile)|!(IE)]><!--><html class="no-js"><!--<![endif]-->
<head>
  <meta charset="utf-8">
  <title>
    
  主从复制 - An Honglei ’s Blog
  

  </title>
  <meta name="author" content="">
  <meta name="description" content="从心开始">

  <meta name="HandheldFriendly" content="True">
  <meta name="MobileOptimized" content="320">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  
  <link href="asset/css/screen.css" media="screen, projection" rel="stylesheet" type="text/css">
  <link href="atom.xml" rel="alternate" title="An Honglei ’s Blog" type="application/atom+xml">
  <script src="asset/js/modernizr-2.0.js"></script>
  <script src="asset/js/jquery.min.js"></script>
  <script src="asset/highlightjs/highlight.pack.js"></script>
  <link href="asset/highlightjs/styles/solarized_light.css" media="screen, projection" rel="stylesheet" type="text/css">
  <script>hljs.initHighlightingOnLoad();</script>

  <style type="text/css">
  .cat-children-p{ padding: 6px 0px;}
  .hljs{background: none;}
  </style>
  <script type="text/javascript">
  var isAddSildbar = true;
  </script>
  <script src="asset/js/octopress.js" type="text/javascript"></script>
</head>
<script type="text/javascript">
//链接新开窗口
function addBlankTargetForLinks () {
  $('a[href^="http"]').each(function(){
      $(this).attr('target', '_blank');
  });
}
$(document).ready(function(event) {
  addBlankTargetForLinks();
});
</script>
<body   >
  <header role="banner"><hgroup>
  <h1><a href="index.html">An Honglei ’s Blog</a></h1>
  
    <h2>从心开始</h2>
  
</hgroup>

</header>
  <nav role="navigation"><ul class="subscription" data-subscription="rss">
  <li><a href="atom.xml" rel="subscribe-rss" title="subscribe via RSS">RSS</a></li>
  
</ul>
  
<form action="http://google.com/search" method="get">
  <fieldset role="search">
    <input type="hidden" name="q" value="site:www.anhaoker.com" />
    <input class="search" type="text" name="q" results="0" placeholder="Search"/>
  </fieldset>
</form>
  
<ul class="main-navigation">

  <li id=""><a target="_self" href="/docker">Docker学习</a></li>

</ul>

</nav>
  <div id="main">
    <div id="content"> 
<div>
	<article class="hentry" role="article">
	<header>
			  	<h1 class="entry-title">主从复制</h1>
				<p class="meta"><time datetime="2018-01-24T22:05:27+08:00" pubdate data-updated="true">2018/1/24</time></p>
			 </header>
		  	<div class="entry-content">
			  	<p>5.6和5.7半同步复制的不同<br/>
<img src="media/15168027270568/15168027711673.jpg" alt=""/></p>

<p>如何实现基于日志点的复制</p>

<p><strong>创建实验数据</strong></p>

<pre><code>root@localhost:(none) 10:14:36 &gt;create database dba;
Query OK, 1 row affected (0.00 sec)

root@localhost:(none) 10:16:59 &gt;use dba;
Database changed
root@localhost:dba 10:17:06 &gt;create table t(id int,c1 varchar(10),primary key(id));
Query OK, 0 rows affected (0.05 sec)

root@localhost:dba 10:17:38 &gt;insert into t values(1,&#39;aa&#39;),(2,&#39;cc&#39;),(3,&#39;dd&#39;);
Query OK, 3 rows affected (0.02 sec)
Records: 3  Duplicates: 0  Warnings: 0

root@localhost:dba 10:18:49 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)

</code></pre>

<h3 id="toc_0">1、在master端建立复制用户</h3>

<pre><code>#建使用这种方式建用户，不建议使用一条语句。
root@localhost:(none) 10:13:33 &gt;create user &#39;dba&#39;@&#39;10.100.4.189&#39; identified by &#39;Root@bd-yg2017&#39;;
Query OK, 0 rows affected (0.00 sec)

root@localhost:(none) 10:13:50 &gt;grant replication slave on *.* to dba@&#39;10.100.4.189&#39;;
Query OK, 0 rows affected (0.01 sec)

</code></pre>

<h3 id="toc_1">2、备份master端的数据，并在slave端恢复</h3>

<p><strong>MASTER主机上操作：</strong></p>

<pre><code>
root@test-mysql-ha-master:~ # mysqldump --single-transaction --master-data=2 --triggers --routines --all-databases -uroot -p &gt; /data/all.sql
Enter password: 
root@test-mysql-ha-master:~ # ll /data/all.sql 
-rw-r--r-- 1 root root 778295 1月  24 22:33 /data/all.sql

--single-transaction
该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时数据库的一致性状态。它只适用于多版本存储引擎，仅InnoDB。本选项和--lock-tables 选项是互斥的，因为LOCK  TABLES 会使任何挂起的事务隐含提交。要想导出大表的话，应结合使用--quick 选项。

--master-data
该选项将binlog的位置和文件名追加到输出文件中。如果为1，将会输出CHANGE MASTER 命令；如果为2，输出的CHANGE  MASTER命令前添加注释信息。该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。该选项自动关闭--lock-tables选项。

值为2时，在dump出的SQL中注释掉下change master语句如：
-- CHANGE MASTER TO MASTER_LOG_FILE=&#39;mysqld-bin.000002&#39;, MASTER_LOG_POS=194;

--triggers
导出触发器。该选项默认启用，用--skip-triggers禁用它。

--routines, -R
导出存储过程以及自定义函数。

</code></pre>

<p><strong>在slave上操作</strong></p>

<pre><code>#将全备数据进行恢复到slave实例
root@test-mysql-ha-slave:~ # mysql -uroot -p -S /tmp/mysql3306.sock &lt; /data/all.sql 
Enter password: 

#验证数据恢复情况
root@localhost:(none) 10:45:27 &gt;show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dba                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

root@localhost:(none) 10:45:36 &gt;use dba;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
root@localhost:dba 10:45:44 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)


</code></pre>

<h3 id="toc_2">3、使用change master 命令配置复制。</h3>

<p><strong>5.7之后不建议使用配置文件，建议在slave使用命令进行管理</strong></p>

<pre><code>root@localhost:dba 10:45:54 &gt;change master to master_host=&#39;10.100.4.188&#39;, master_user=&#39;dba&#39;,
master_password=&#39;Root@bd-yg2017&#39;,
master_log_file=&#39;mysqld-bin.000002&#39;,
master_log_pos=194;
Query OK, 0 rows affected, 2 warnings (0.20 sec)

root@localhost:dba 10:55:07 &gt;start slave;
Query OK, 0 rows affected (0.09 sec)


root@localhost:dba 11:02:51 &gt;show slave status\G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.100.4.188
                  Master_User: dba
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysqld-bin.000002
          Read_Master_Log_Pos: 194
               Relay_Log_File: relay-bin.000002
                Relay_Log_Pos: 321
        Relay_Master_Log_File: mysqld-bin.000002
            ** Slave_IO_Running: Yes**
          **Slave_SQL_Running: Yes**
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 194
              Relay_Log_Space: 522
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 18882
                  Master_UUID: e271ce20-3b0a-4722-ba8d-1deab072319b
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: d502a626-d64c-4755-819e-7fe6954cfda5:1-6
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

</code></pre>

<h3 id="toc_3">验证</h3>

<p>在主上添加数据或删除数据查看从库变化</p>

<pre><code>#master操作
root@localhost:dba 11:06:15 &gt;insert into t values(4,&#39;eee&#39;),(5,&#39;ddd&#39;);
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

root@localhost:dba 11:06:48 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

#slave 验证
root@localhost:dba 11:02:59 &gt;use dba;
Database changed
root@localhost:dba 11:08:14 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

分析：数据已同步过来

</code></pre>

<h3 id="toc_4">主从管理的系统视图</h3>

<pre><code>
root@localhost:dba 11:08:22 &gt;use performance_schema;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

root@localhost:performance_schema 11:16:12 &gt;show tables like &#39;replication%&#39;;
+---------------------------------------------+
| Tables_in_performance_schema (replication%) |
+---------------------------------------------+
| replication_applier_configuration           |
| replication_applier_status                  |
| replication_applier_status_by_coordinator   |
| replication_applier_status_by_worker        |
| replication_connection_configuration        |
| replication_connection_status               |
| replication_group_member_stats              |
| replication_group_members                   |
+---------------------------------------------+
8 rows in set (0.00 sec)


</code></pre>

			</div>

		
	  
		<footer>
		 <p class="meta">

			<strong>Categories:</strong>&nbsp; 
			<span class="categories">
			
			    <a class='category' href='%E9%AB%98%E5%8F%AF%E7%94%A8%E6%9E%B6%E6%9E%84.html'>高可用架构</a>&nbsp;
			 
			</span>
		    </p>
		    <p class="meta">
		      
		 </p>
	    
		<div class="sharing">
		  22222
          

          

		</div>

	    <p class="meta">
	    
	        <a class="basic-alignment left" href="15168067802180.html" 
	        title="Previous Post: 将基于日志的复制变为基于事务的日志">&laquo; 将基于日志的复制变为基于事务的日志</a>
	    
	    
	        <a class="basic-alignment right" href="15168707048085.html" 
	        title="Next Post: DBA学习考试题">DBA学习考试题 &raquo;</a>
	    
	    </p>
	  </footer>
	</article>
</div>
 <aside class="sidebar"> 

	<section>
	  <h1>Categories</h1>
	  <ul id="recent_posts">
	  
	      <li class="post">
	        <a href="mysql.html"><strong>mysql&nbsp;(8)</strong></a>
	         <p class="cat-children-p"> 
	        
	        	<a href="DBA%E5%AD%A6%E4%B9%A0.html">DBA学习&nbsp;(7)</a>&nbsp;&nbsp;
	        
	         </p> 
	      </li>
	   
	  </ul>
	</section>
	<section>
	  <h1>Recent Posts</h1>
	  <ul id="recent_posts">
	  
	      
		      <li class="post">
		        <a href="15168067802180.html">将基于日志的复制变为基于事务的日志</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15168027270568.html">主从复制</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15168707048085.html">DBA学习考试题</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15159241671517.html">3.1.6 第6章 服务器硬件优化 - 安红雷</a>
		      </li>
	     
	  
	      
		      <li class="post">
		        <a href="15159241218009.html">3.1.5 第5章 系统配置优化 - 安红雷</a>
		      </li>
	     
	  
	      
	  
	      
	  
	      
	   
	  </ul>
	</section>
	
</aside> </div></div>
  <footer role="contentinfo"><p>
  Copyright &copy; 2014 -  -
  <span class="credit">Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a> &nbsp;&nbsp; Theme by <a href="http://octopress.org">Octopress</a></span>
</p>

</footer>

  
    

<script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>
3333
</body>
</html>