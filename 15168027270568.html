<!DOCTYPE html>
<html>

<head>
    <title>
         主从复制 - An Honglei ’s Blog 
    </title>

    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="description" content="从心开始">

    <link rel="stylesheet" type="text/css" href="asset/yue.css">
    <link rel="stylesheet" type="text/css" href="asset/main.css">
    <link rel="stylesheet" type="text/css" href="asset/tomorrow.css">

    <link rel="alternate" type="application/atom+xml" href="atom.xml" title="An Honglei ’s Blog">

    <script src="asset/highlight.pack.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
</head>

<body>
    <header class="yue site-header">
        <div class="wrapper">
            <a class="site-title" href="index.html">An Honglei ’s Blog</a>
            <nav class="site-nav">
                <a href="#" class="menu-icon">
                    
                    <svg viewBox="0 0 18 15">
                        <path fill="#424242" d="M18,1.484c0,0.82-0.665,1.484-1.484,1.484H1.484C0.665,2.969,0,2.304,0,1.484l0,0C0,0.665,0.665,0,1.484,0 h15.031C17.335,0,18,0.665,18,1.484L18,1.484z"
                        />
                        <path fill="#424242" d="M18,7.516C18,8.335,17.335,9,16.516,9H1.484C0.665,9,0,8.335,0,7.516l0,0c0-0.82,0.665-1.484,1.484-1.484 h15.031C17.335,6.031,18,6.696,18,7.516L18,7.516z"
                        />
                        <path fill="#424242" d="M18,13.516C18,14.335,17.335,15,16.516,15H1.484C0.665,15,0,14.335,0,13.516l0,0 c0-0.82,0.665-1.484,1.484-1.484h15.031C17.335,12.031,18,12.696,18,13.516L18,13.516z"
                        />
                    </svg>

                </a>
                <div class="trigger">
                    
                        <a class="page-link" href="index.html">Home</a>
                    
                        <a class="page-link" href="archives.html">Archives</a>
                    
                        <a class="page-link" href="/docker">Docker</a>
                    
                </div>
            </nav>
        </div>
    </header>
</body>

</html> <script async defer src="//hypothes.is/embed.js"></script>
<div class="page-content yue">
    <div class="wrapper">
        <article class="post" itemscope itemtype="http://schema.org/BlogPosting">
            <header class="post-header">
                <h1 class="post-title" itemprop="name headline">主从复制</h1>
                <div class="post-description">
                    
                        <p>5.6和5.7半同步复制的不同<br/>
<img src="media/15168027270568/15168027711673.jpg" alt=""/></p>

<p>如何实现基于日志点的复制</p>

<p><strong>创建实验数据</strong></p>

<pre><code>root@localhost:(none) 10:14:36 &gt;create database dba;
Query OK, 1 row affected (0.00 sec)

root@localhost:(none) 10:16:59 &gt;use dba;
Database changed
root@localhost:dba 10:17:06 &gt;create table t(id int,c1 varchar(10),primary key(id));
Query OK, 0 rows affected (0.05 sec)

root@localhost:dba 10:17:38 &gt;insert into t values(1,&#39;aa&#39;),(2,&#39;cc&#39;),(3,&#39;dd&#39;);
Query OK, 3 rows affected (0.02 sec)
Records: 3  Duplicates: 0  Warnings: 0

root@localhost:dba 10:18:49 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)

</code></pre>

<h3 id="toc_0">1、在master端建立复制用户</h3>

<pre><code>#建使用这种方式建用户，不建议使用一条语句。
root@localhost:(none) 10:13:33 &gt;create user &#39;dba&#39;@&#39;10.100.4.189&#39; identified by &#39;Root@bd-yg2017&#39;;
Query OK, 0 rows affected (0.00 sec)

root@localhost:(none) 10:13:50 &gt;grant replication slave on *.* to dba@&#39;10.100.4.189&#39;;
Query OK, 0 rows affected (0.01 sec)

</code></pre>

<h3 id="toc_1">2、备份master端的数据，并在slave端恢复</h3>

<p><strong>MASTER主机上操作：</strong></p>

<pre><code>
root@test-mysql-ha-master:~ # mysqldump --single-transaction --master-data=2 --triggers --routines --all-databases -uroot -p &gt; /data/all.sql
Enter password: 
root@test-mysql-ha-master:~ # ll /data/all.sql 
-rw-r--r-- 1 root root 778295 1月  24 22:33 /data/all.sql

--single-transaction
该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时数据库的一致性状态。它只适用于多版本存储引擎，仅InnoDB。本选项和--lock-tables 选项是互斥的，因为LOCK  TABLES 会使任何挂起的事务隐含提交。要想导出大表的话，应结合使用--quick 选项。

--master-data
该选项将binlog的位置和文件名追加到输出文件中。如果为1，将会输出CHANGE MASTER 命令；如果为2，输出的CHANGE  MASTER命令前添加注释信息。该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。该选项自动关闭--lock-tables选项。

值为2时，在dump出的SQL中注释掉下change master语句如：
-- CHANGE MASTER TO MASTER_LOG_FILE=&#39;mysqld-bin.000002&#39;, MASTER_LOG_POS=194;

--triggers
导出触发器。该选项默认启用，用--skip-triggers禁用它。

--routines, -R
导出存储过程以及自定义函数。

</code></pre>

<p><strong>在slave上操作</strong></p>

<pre><code>#将全备数据进行恢复到slave实例
root@test-mysql-ha-slave:~ # mysql -uroot -p -S /tmp/mysql3306.sock &lt; /data/all.sql 
Enter password: 

#验证数据恢复情况
root@localhost:(none) 10:45:27 &gt;show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dba                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

root@localhost:(none) 10:45:36 &gt;use dba;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
root@localhost:dba 10:45:44 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)


</code></pre>

<h3 id="toc_2">3、使用change master 命令配置复制。</h3>

<p><strong>5.7之后不建议使用配置文件，建议在slave使用命令进行管理</strong></p>

<pre><code>root@localhost:dba 10:45:54 &gt;change master to master_host=&#39;10.100.4.188&#39;, master_user=&#39;dba&#39;,
master_password=&#39;Root@bd-yg2017&#39;,
master_log_file=&#39;mysqld-bin.000002&#39;,
master_log_pos=194;
Query OK, 0 rows affected, 2 warnings (0.20 sec)

root@localhost:dba 10:55:07 &gt;start slave;
Query OK, 0 rows affected (0.09 sec)


root@localhost:dba 11:02:51 &gt;show slave status\G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.100.4.188
                  Master_User: dba
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysqld-bin.000002
          Read_Master_Log_Pos: 194
               Relay_Log_File: relay-bin.000002
                Relay_Log_Pos: 321
        Relay_Master_Log_File: mysqld-bin.000002
            ** Slave_IO_Running: Yes**
          **Slave_SQL_Running: Yes**
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 194
              Relay_Log_Space: 522
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 18882
                  Master_UUID: e271ce20-3b0a-4722-ba8d-1deab072319b
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: d502a626-d64c-4755-819e-7fe6954cfda5:1-6
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

</code></pre>

<h3 id="toc_3">验证</h3>

<p>在主上添加数据或删除数据查看从库变化</p>

<pre><code>#master操作
root@localhost:dba 11:06:15 &gt;insert into t values(4,&#39;eee&#39;),(5,&#39;ddd&#39;);
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

root@localhost:dba 11:06:48 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

#slave 验证
root@localhost:dba 11:02:59 &gt;use dba;
Database changed
root@localhost:dba 11:08:14 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

分析：数据已同步过来

</code></pre>

<h3 id="toc_4">主从管理的系统视图</h3>

<pre><code>
root@localhost:dba 11:08:22 &gt;use performance_schema;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

root@localhost:performance_schema 11:16:12 &gt;show tables like &#39;replication%&#39;;
+---------------------------------------------+
| Tables_in_performance_schema (replication%) |
+---------------------------------------------+
| replication_applier_configuration           |
| replication_applier_status                  |
| replication_applier_status_by_coordinator   |
| replication_applier_status_by_worker        |
| replication_connection_configuration        |
| replication_connection_status               |
| replication_group_member_stats              |
| replication_group_members                   |
+---------------------------------------------+
8 rows in set (0.00 sec)


</code></pre>

                    
                </div>
                <p class="post-meta">
                    <time class="post-time" datetime="2018-01-24T22:05:27+08:00"itemprop="datePublished">Created by Tisoga at 2018/1/24</time>
                </p>
            </header>
            <div class="post-content" itemprop="articleBody">
                <p>5.6和5.7半同步复制的不同<br/>
<img src="media/15168027270568/15168027711673.jpg" alt=""/></p>

<p>如何实现基于日志点的复制</p>

<p><strong>创建实验数据</strong></p>

<pre><code>root@localhost:(none) 10:14:36 &gt;create database dba;
Query OK, 1 row affected (0.00 sec)

root@localhost:(none) 10:16:59 &gt;use dba;
Database changed
root@localhost:dba 10:17:06 &gt;create table t(id int,c1 varchar(10),primary key(id));
Query OK, 0 rows affected (0.05 sec)

root@localhost:dba 10:17:38 &gt;insert into t values(1,&#39;aa&#39;),(2,&#39;cc&#39;),(3,&#39;dd&#39;);
Query OK, 3 rows affected (0.02 sec)
Records: 3  Duplicates: 0  Warnings: 0

root@localhost:dba 10:18:49 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)

</code></pre>

<h3 id="toc_0">1、在master端建立复制用户</h3>

<pre><code>#建使用这种方式建用户，不建议使用一条语句。
root@localhost:(none) 10:13:33 &gt;create user &#39;dba&#39;@&#39;10.100.4.189&#39; identified by &#39;Root@bd-yg2017&#39;;
Query OK, 0 rows affected (0.00 sec)

root@localhost:(none) 10:13:50 &gt;grant replication slave on *.* to dba@&#39;10.100.4.189&#39;;
Query OK, 0 rows affected (0.01 sec)

</code></pre>

<h3 id="toc_1">2、备份master端的数据，并在slave端恢复</h3>

<p><strong>MASTER主机上操作：</strong></p>

<pre><code>
root@test-mysql-ha-master:~ # mysqldump --single-transaction --master-data=2 --triggers --routines --all-databases -uroot -p &gt; /data/all.sql
Enter password: 
root@test-mysql-ha-master:~ # ll /data/all.sql 
-rw-r--r-- 1 root root 778295 1月  24 22:33 /data/all.sql

--single-transaction
该选项在导出数据之前提交一个BEGIN SQL语句，BEGIN 不会阻塞任何应用程序且能保证导出时数据库的一致性状态。它只适用于多版本存储引擎，仅InnoDB。本选项和--lock-tables 选项是互斥的，因为LOCK  TABLES 会使任何挂起的事务隐含提交。要想导出大表的话，应结合使用--quick 选项。

--master-data
该选项将binlog的位置和文件名追加到输出文件中。如果为1，将会输出CHANGE MASTER 命令；如果为2，输出的CHANGE  MASTER命令前添加注释信息。该选项将打开--lock-all-tables 选项，除非--single-transaction也被指定（在这种情况下，全局读锁在开始导出时获得很短的时间；其他内容参考下面的--single-transaction选项）。该选项自动关闭--lock-tables选项。

值为2时，在dump出的SQL中注释掉下change master语句如：
-- CHANGE MASTER TO MASTER_LOG_FILE=&#39;mysqld-bin.000002&#39;, MASTER_LOG_POS=194;

--triggers
导出触发器。该选项默认启用，用--skip-triggers禁用它。

--routines, -R
导出存储过程以及自定义函数。

</code></pre>

<p><strong>在slave上操作</strong></p>

<pre><code>#将全备数据进行恢复到slave实例
root@test-mysql-ha-slave:~ # mysql -uroot -p -S /tmp/mysql3306.sock &lt; /data/all.sql 
Enter password: 

#验证数据恢复情况
root@localhost:(none) 10:45:27 &gt;show databases;
+--------------------+
| Database           |
+--------------------+
| information_schema |
| dba                |
| mysql              |
| performance_schema |
| sys                |
+--------------------+
5 rows in set (0.01 sec)

root@localhost:(none) 10:45:36 &gt;use dba;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed
root@localhost:dba 10:45:44 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
+----+------+
3 rows in set (0.00 sec)


</code></pre>

<h3 id="toc_2">3、使用change master 命令配置复制。</h3>

<p><strong>5.7之后不建议使用配置文件，建议在slave使用命令进行管理</strong></p>

<pre><code>root@localhost:dba 10:45:54 &gt;change master to master_host=&#39;10.100.4.188&#39;, master_user=&#39;dba&#39;,
master_password=&#39;Root@bd-yg2017&#39;,
master_log_file=&#39;mysqld-bin.000002&#39;,
master_log_pos=194;
Query OK, 0 rows affected, 2 warnings (0.20 sec)

root@localhost:dba 10:55:07 &gt;start slave;
Query OK, 0 rows affected (0.09 sec)


root@localhost:dba 11:02:51 &gt;show slave status\G
*************************** 1. row ***************************
               Slave_IO_State: Waiting for master to send event
                  Master_Host: 10.100.4.188
                  Master_User: dba
                  Master_Port: 3306
                Connect_Retry: 60
              Master_Log_File: mysqld-bin.000002
          Read_Master_Log_Pos: 194
               Relay_Log_File: relay-bin.000002
                Relay_Log_Pos: 321
        Relay_Master_Log_File: mysqld-bin.000002
            ** Slave_IO_Running: Yes**
          **Slave_SQL_Running: Yes**
              Replicate_Do_DB: 
          Replicate_Ignore_DB: 
           Replicate_Do_Table: 
       Replicate_Ignore_Table: 
      Replicate_Wild_Do_Table: 
  Replicate_Wild_Ignore_Table: 
                   Last_Errno: 0
                   Last_Error: 
                 Skip_Counter: 0
          Exec_Master_Log_Pos: 194
              Relay_Log_Space: 522
              Until_Condition: None
               Until_Log_File: 
                Until_Log_Pos: 0
           Master_SSL_Allowed: No
           Master_SSL_CA_File: 
           Master_SSL_CA_Path: 
              Master_SSL_Cert: 
            Master_SSL_Cipher: 
               Master_SSL_Key: 
        Seconds_Behind_Master: 0
Master_SSL_Verify_Server_Cert: No
                Last_IO_Errno: 0
                Last_IO_Error: 
               Last_SQL_Errno: 0
               Last_SQL_Error: 
  Replicate_Ignore_Server_Ids: 
             Master_Server_Id: 18882
                  Master_UUID: e271ce20-3b0a-4722-ba8d-1deab072319b
             Master_Info_File: mysql.slave_master_info
                    SQL_Delay: 0
          SQL_Remaining_Delay: NULL
      Slave_SQL_Running_State: Slave has read all relay log; waiting for more updates
           Master_Retry_Count: 86400
                  Master_Bind: 
      Last_IO_Error_Timestamp: 
     Last_SQL_Error_Timestamp: 
               Master_SSL_Crl: 
           Master_SSL_Crlpath: 
           Retrieved_Gtid_Set: 
            Executed_Gtid_Set: d502a626-d64c-4755-819e-7fe6954cfda5:1-6
                Auto_Position: 0
         Replicate_Rewrite_DB: 
                 Channel_Name: 
           Master_TLS_Version: 
1 row in set (0.00 sec)

</code></pre>

<h3 id="toc_3">验证</h3>

<p>在主上添加数据或删除数据查看从库变化</p>

<pre><code>#master操作
root@localhost:dba 11:06:15 &gt;insert into t values(4,&#39;eee&#39;),(5,&#39;ddd&#39;);
Query OK, 2 rows affected (0.01 sec)
Records: 2  Duplicates: 0  Warnings: 0

root@localhost:dba 11:06:48 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

#slave 验证
root@localhost:dba 11:02:59 &gt;use dba;
Database changed
root@localhost:dba 11:08:14 &gt;select * from t;
+----+------+
| id | c1   |
+----+------+
|  1 | aa   |
|  2 | cc   |
|  3 | dd   |
|  4 | eee  |
|  5 | ddd  |
+----+------+
5 rows in set (0.00 sec)

分析：数据已同步过来

</code></pre>

<h3 id="toc_4">主从管理的系统视图</h3>

<pre><code>
root@localhost:dba 11:08:22 &gt;use performance_schema;
Reading table information for completion of table and column names
You can turn off this feature to get a quicker startup with -A

Database changed

root@localhost:performance_schema 11:16:12 &gt;show tables like &#39;replication%&#39;;
+---------------------------------------------+
| Tables_in_performance_schema (replication%) |
+---------------------------------------------+
| replication_applier_configuration           |
| replication_applier_status                  |
| replication_applier_status_by_coordinator   |
| replication_applier_status_by_worker        |
| replication_connection_configuration        |
| replication_connection_status               |
| replication_group_member_stats              |
| replication_group_members                   |
+---------------------------------------------+
8 rows in set (0.00 sec)


</code></pre>

            </div>
            <div>
                22222
                
                
            </div>
        </article>
    </div>
</div>
  <footer id="footer" class="yue">
    <div class="wrapper">
        <p>Designed and Written by <a href="https://twitter.com/Tisoga">Tisoga</a></p>
    </div>
</footer>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>
3333