<!doctype html>
<html class="no-js" lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>
    
  # Prometheus 简介及安装 - An Honglei ’s Blog
  
  </title>
 <meta name="description" content="学习是痛并快乐着！！！">
 <link href="atom.xml" rel="alternate" title="An Honglei ’s Blog" type="application/atom+xml">
    <link rel="stylesheet" href="asset/css/foundation.min.css" />
    <link rel="stylesheet" href="asset/css/docs.css" />

    <script src="asset/js/vendor/modernizr.js"></script>
    <script src="asset/js/vendor/jquery.js"></script>
    <script src="asset/highlightjs/highlight.pack.js"></script>
    <link href="asset/highlightjs/styles/github.css" media="screen, projection" rel="stylesheet" type="text/css">
    <script>hljs.initHighlightingOnLoad();</script>
    
  </head>
  <body class="antialiased hide-extras">
    
    <div class="marketing off-canvas-wrap" data-offcanvas>
      <div class="inner-wrap">


<nav class="top-bar docs-bar hide-for-small" data-topbar>

<div id="header">
    <h1><a href="index.html">An Honglei ’s Blog</a></h1>
</div>

</nav>
        <nav class="tab-bar show-for-small">
  <a href="javascript:void(0)" class="left-off-canvas-toggle menu-icon">
    <span> &nbsp; An Honglei ’s Blog</span>
  </a>
</nav>

<aside class="left-off-canvas-menu">
      <ul class="off-canvas-list">
      <li><a href="index.html">Home</a></li>
      
        <li class="divider"></li>
        <li><label>监控</label></li>

          
            <li><a title="IPMI-DELL" href="15287735246134.html">IPMI-DELL</a></li>
          
            <li><a title="VM WARE esxi" href="15286986347471.html">VM WARE esxi</a></li>
          
            <li><a title="IO监控" href="15284429017864.html">IO监控</a></li>
          
            <li><a title="zookeeper" href="15284264486830.html">zookeeper</a></li>
          
            <li><a title="docker" href="15284264396270.html">docker</a></li>
          
            <li><a title="redis" href="15284264338352.html">redis</a></li>
          
            <li><a title="mongodb" href="15284264265436.html">mongodb</a></li>
          
            <li><a title="mysql" href="15284264221433.html">mysql</a></li>
          
            <li><a title="nginx" href="15284264147825.html">nginx</a></li>
          
            <li><a title="JVM" href="15284264028937.html">JVM</a></li>
          
            <li><a title="配置报警-邮件和微信" href="15284261636485.html">配置报警-邮件和微信</a></li>
          
            <li><a title="自动发现设置" href="15284261175013.html">自动发现设置</a></li>
          
            <li><a title="Alertmanager报警模块" href="15270467833243.html">Alertmanager报警模块</a></li>
          
            <li><a title="运维监控工作规划" href="15264350522088.html">运维监控工作规划</a></li>
          
            <li><a title="# Prometheus 简介及安装" href="15258517853636.html"># Prometheus 简介及安装</a></li>
          
            <li><a title="部署 Prometheus 基础环境" href="15258308100903.html">部署 Prometheus 基础环境</a></li>
          
            <li><a title="prometheus监控调研方案" href="15257584688763.html">prometheus监控调研方案</a></li>
          
            <li><a title="监控迁移过程注意事项整理" href="15253278795397.html">监控迁移过程注意事项整理</a></li>
          
            <li><a title="zabbix3.2升级到3.4" href="15246459775922.html">zabbix3.2升级到3.4</a></li>
          
            <li><a title="zabbix3.2/3.4 部署安装" href="15246196912882.html">zabbix3.2/3.4 部署安装</a></li>
          
            <li><a title="天兔" href="15243054043731.html">天兔</a></li>
          

      
        <li class="divider"></li>
        <li><label>Python</label></li>

          
            <li><a title="基础知识练习" href="15221590998154.html">基础知识练习</a></li>
          
            <li><a title="python 基础" href="15214289229123.html">python 基础</a></li>
          

      
        <li class="divider"></li>
        <li><label>基础整理</label></li>

          
            <li><a title="LINUX 快捷键整理" href="15306935051951.html">LINUX 快捷键整理</a></li>
          

      
      </ul>
    </aside>

<a class="exit-off-canvas" href="#"></a>

        <section id="main-content" role="main" class="scroll-container">

          <div class="row">
            <div class="large-3 medium-3 columns">
              <div class="hide-for-small">
                <div class="sidebar">
                <nav>
                  <ul id="side-nav" class="side-nav">

                    
                      <li class="side-title"><span>监控</span></li>
                        
                          <li><a title="IPMI-DELL" href="15287735246134.html">IPMI-DELL</a></li>
                        
                          <li><a title="VM WARE esxi" href="15286986347471.html">VM WARE esxi</a></li>
                        
                          <li><a title="IO监控" href="15284429017864.html">IO监控</a></li>
                        
                          <li><a title="zookeeper" href="15284264486830.html">zookeeper</a></li>
                        
                          <li><a title="docker" href="15284264396270.html">docker</a></li>
                        
                          <li><a title="redis" href="15284264338352.html">redis</a></li>
                        
                          <li><a title="mongodb" href="15284264265436.html">mongodb</a></li>
                        
                          <li><a title="mysql" href="15284264221433.html">mysql</a></li>
                        
                          <li><a title="nginx" href="15284264147825.html">nginx</a></li>
                        
                          <li><a title="JVM" href="15284264028937.html">JVM</a></li>
                        
                          <li><a title="配置报警-邮件和微信" href="15284261636485.html">配置报警-邮件和微信</a></li>
                        
                          <li><a title="自动发现设置" href="15284261175013.html">自动发现设置</a></li>
                        
                          <li><a title="Alertmanager报警模块" href="15270467833243.html">Alertmanager报警模块</a></li>
                        
                          <li><a title="运维监控工作规划" href="15264350522088.html">运维监控工作规划</a></li>
                        
                          <li><a title="# Prometheus 简介及安装" href="15258517853636.html"># Prometheus 简介及安装</a></li>
                        
                          <li><a title="部署 Prometheus 基础环境" href="15258308100903.html">部署 Prometheus 基础环境</a></li>
                        
                          <li><a title="prometheus监控调研方案" href="15257584688763.html">prometheus监控调研方案</a></li>
                        
                          <li><a title="监控迁移过程注意事项整理" href="15253278795397.html">监控迁移过程注意事项整理</a></li>
                        
                          <li><a title="zabbix3.2升级到3.4" href="15246459775922.html">zabbix3.2升级到3.4</a></li>
                        
                          <li><a title="zabbix3.2/3.4 部署安装" href="15246196912882.html">zabbix3.2/3.4 部署安装</a></li>
                        
                          <li><a title="天兔" href="15243054043731.html">天兔</a></li>
                        

                    
                      <li class="side-title"><span>Python</span></li>
                        
                          <li><a title="基础知识练习" href="15221590998154.html">基础知识练习</a></li>
                        
                          <li><a title="python 基础" href="15214289229123.html">python 基础</a></li>
                        

                    
                      <li class="side-title"><span>基础整理</span></li>
                        
                          <li><a title="LINUX 快捷键整理" href="15306935051951.html">LINUX 快捷键整理</a></li>
                        

                    
                  </ul>
                </nav>
                </div>
              </div>
            </div>
            <div class="large-9 medium-9 columns">

 <div class="markdown-body">
<h1># Prometheus 简介及安装</h1>

<blockquote>
<p>什么是 Prometheus</p>

<p>主要功能</p>

<p>核心组件</p>

<p>基础架构</p>

<p>安装部署监控系统</p>
</blockquote>

<h2 id="toc_0">什么是 Prometheus</h2>

<p>Prometheus 是由 SoundCloud 开源监控告警解决方案，从 2012 年开始编写代码，再到 2015 年 github 上开源以来，已经吸引了 9k+ 关注，以及很多大公司的使用；2016 年 Prometheus 成为继 k8s 后，第二名 CNCF(Cloud Native Computing Foundation) 成员。<br/>
作为新一代开源解决方案，很多理念与 Google SRE 运维之道不谋而合。</p>

<h2 id="toc_1">主要功能</h2>

<ul>
<li><p>多维 数据模型（时序由 metric 名字和 k/v 的 labels 构成）。</p></li>
<li><p>灵活的查询语句（PromQL）。</p></li>
<li><p>无依赖存储，支持 local 和 remote 不同模型。</p></li>
<li><p>采用 http 协议，使用 pull 模式，拉取数据，简单易懂。</p></li>
<li><p>监控目标，可以采用服务发现或静态配置的方式。</p></li>
<li><p>支持多种统计数据模型，图形化友好。</p></li>
</ul>

<h2 id="toc_2">核心组件</h2>

<ol>
<li>Prometheus Server， 主要用于抓取数据和存储时序数据，另外还提供查询和 Alert Rule 配置管理。</li>
<li>client libraries，用于对接 Prometheus Server, 可以查询和上报数据。</li>
<li>push gateway ，用于批量，短期的监控数据的汇总节点，主要用于业务数据汇报等。</li>
<li>各种汇报数据的 exporters ，例如汇报机器数据的 node_exporter, 汇报 MongoDB 信息的 MongoDB exporter 等等。</li>
<li>用于告警通知管理的 alertmanager 。</li>
</ol>

<h2 id="toc_3">基础架构</h2>

<p>下面这张图说明了Prometheus的整体架构，以及生态中的一些组件作用:</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245483444586.jpg" alt=""/></p>

<p>从这个架构图，也可以看出 Prometheus 的主要模块包含， Server, Exporters, Pushgateway, PromQL, Alertmanager, WebUI 等。</p>

<p>它大致使用逻辑是这样：</p>

<ol>
<li>Prometheus server 定期从静态配置的 targets 或者服务发现的 targets 拉取数据。</li>
<li>当新拉取的数据大于配置内存缓存区的时候，Prometheus 会将数据持久化到磁盘（如果使用 remote storage 将持久化到云端）。</li>
<li>Prometheus 可以配置 rules，然后定时查询数据，当条件触发的时候，会将 alert 推送到配置的 Alertmanager。</li>
<li>Alertmanager 收到警告的时候，可以根据配置，聚合，去重，降噪，最后发送警告。</li>
<li>可以使用 API， Prometheus Console 或者 Grafana 查询和聚合数据。</li>
</ol>

<h2 id="toc_4">注意</h2>

<ul>
<li><p>Prometheus 的数据是基于时序的 float64 的值，如果你的数据值有更多类型，无法满足。</p></li>
<li><p>Prometheus 不适合做审计计费，因为它的数据是按一定时间采集的，关注的更多是系统的运行瞬时状态以及趋势，即使有少量数据没有采集也能容忍，但是审计计费需要记录每个请求，并且数据长期存储，这个和 Prometheus 无法满足，可能需要采用专门的审计系统。</p></li>
</ul>

<h2 id="toc_5">安装部署</h2>

<h3 id="toc_6">1. 环境说明</h3>

<table>
<thead>
<tr>
<th>角色</th>
<th>IP地址</th>
<th>OS</th>
</tr>
</thead>

<tbody>
<tr>
<td>Prometheus Server <br> Grafana Server</td>
<td>10.100.4.181</td>
<td>Centos7.4</td>
</tr>
<tr>
<td>Prometheus Node</td>
<td>10.100.4.182</td>
<td>Centos7.4</td>
</tr>
</tbody>
</table>

<h3 id="toc_7">2. 软件包版本</h3>

<p>Prometheus 下载： <a href="https://github.com/prometheus/prometheus/releases/download/v2.2.1/prometheus-2.2.1.linux-amd64.tar.gz">https://github.com/prometheus/prometheus/releases/download/v2.2.1/prometheus-2.2.1.linux-amd64.tar.gz</a></p>

<p>node_exporter 下载：<a href="https://github.com/prometheus/node_exporter/releases/download/v0.15.1/node_exporter-0.15.1.linux-amd64.tar.gz">https://github.com/prometheus/node_exporter/releases/download/v0.15.1/node_exporter-0.15.1.linux-amd64.tar.gz</a></p>

<p>Grafana 下载：<a href="https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.6.2-1.x86_64.rpm">https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.6.2-1.x86_64.rpm</a></p>

<h3 id="toc_8">3. 部署 Prometheus</h3>

<p><strong>下载</strong></p>

<pre><code class="language-bash">$ cd /usr/local/src/
$ wget https://github.com/prometheus/prometheus/releases/download/v2.2.1/prometheus-2.2.1.linux-amd64.tar.gz
</code></pre>

<p><strong>部署到/usr/local/目录</strong><br/>
<strong>promethus不用编译安装，解压目录中有配置文件与启动文件</strong></p>

<pre><code class="language-bash">$ tar xf prometheus-2.2.1.linux-amd64.tar.gz -C /usr/local/
$ cd /usr/local/
$ ln -sv prometheus-2.2.1.linux-amd64 prometheus
</code></pre>

<p><strong>验证</strong></p>

<pre><code class="language-bash">$ cd prometheus
$ ./prometheus --version
</code></pre>

<p><strong>配置文件</strong></p>

<pre><code class="language-bash"># 解压目录中的 prometheus.yml
# my global config
global:
  scrape_interval:     15s # 设置抓取(pull)时间间隔，默认是1m
  evaluation_interval: 15s # 设置rules评估时间间隔，默认是1m
  # scrape_timeout is set to the global default (10s).

# 告警管理配置，暂未使用，默认配置
alerting:
  alertmanagers:
  - static_configs:
    - targets:
      # - alertmanager:9093

# 加载rules，并根据设置的时间间隔定期评估，暂未使用，默认配置
rule_files:
  # - &quot;first_rules.yml&quot;
  # - &quot;second_rules.yml&quot;

# 这里就表示抓取对象的配置
# 这里是抓去promethues自身的配置
scrape_configs:
  # The job name is added as a label `job=&lt;job_name&gt;` to any timeseries scraped from this config.
  - job_name: &#39;prometheus&#39;

    # metrics_path defaults to &#39;/metrics&#39;
    # scheme defaults to &#39;http&#39;.
    # 重写了全局抓取间隔时间，由15秒重写成5秒。
    scrape_interval: 5s

    static_configs:
      - targets: [&#39;localhost:9090&#39;]
  # 新添加的对其它node节点抓取数据
  - job_name: &quot;linux&quot;
    scrape_interval: 10s
    
    static_configs:
      - targets: [&#39;10.100.4.182:9100&#39;]
</code></pre>

<p><strong>创建用户</strong></p>

<pre><code class="language-bash">$ groupadd prometheus
$ useradd -g prometheus -s /sbin/nologin prometheus
$ chown -R prometheus.prometheus /usr/local/prometheus
</code></pre>

<p><strong>创建 Systemd 服务</strong></p>

<pre><code class="language-bash">$ vim /usr/lib/systemd/system/prometheus.service

[unit]
Description=Prometheus Server
Documentation=https://prometheus.io/docs/introduction/overview/
After=network.target

[Service]
Restart=on-failure
WorkingDirectory=/usr/local/prometheus/
ExecStart=/usr/local/prometheus/prometheus
-config.file=/usr/local/prometheus/prometheus.yml

[Install]
WantedBy=multi-user.target
</code></pre>

<p><strong>设置 iptables 规则</strong></p>

<pre><code class="language-bash">-A INPUT -p tcp -m state --state NEW -m tcp --dport 9090 -j ACCEPT
</code></pre>

<p><strong>验证服务状态</strong></p>

<pre><code class="language-bash">$ ss -tnl | grep 9090
</code></pre>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245551884229.jpg" alt=""/></p>

<p>访问 Prometheus 自带的 Web，访问方式： IP:Port</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245553219848.jpg" alt=""/></p>

<h3 id="toc_9">4. 部署 node_exporter</h3>

<p>Node_exporter 收集机器的系统数据，这里采用 prometheus 官方提供的exporter，除 node_exporter 外，官方还提供 consul，memcached，haproxy，mysqld 等 exporter，具体可查看官网。</p>

<p><strong>1. 下载&amp;部署</strong></p>

<pre><code class="language-bash"># 下载
$ cd /usr/local/src/
$ wget https://github.com/prometheus/node_exporter/releases/download/v0.15.1/node_exporter-0.15.1.linux-amd64.tar.gz

# 部署
$ tar xf node_exporter-0.15.2.linux-amd64.tar.gz -C /usr/local/
$ cd /usr/local/
$ mv node_exporter-0.15.2.linux-amd64 node_exporter
</code></pre>

<p><strong>2. 设置用户</strong></p>

<pre><code class="language-bash">$ groupadd prometheus
$ useradd -g prometheus -s /sbin/nologin prometheus
$ chown -R prometheus:prometheus /usr/local/node_exporter/
</code></pre>

<p><strong>3. 创建 Systemd 服务</strong></p>

<pre><code class="language-bash">$ vim /usr/lib/systemd/system/node_exporter.service

[Unit]
Description=node_exporter
Documentation=https://prometheus.io/
After=network.target

[Service]
Type=simple
User=prometheus
ExecStart=/usr/local/node_exporter/node_exporter
Restart=on-failure

[Install]
WantedBy=multi-user.target

# 启动 node_exporter
$ systemctl enable node_exporte
$ systemctl start node_exporter
</code></pre>

<p><strong>4. 设置 iptables 规则</strong></p>

<pre><code class="language-bash"># 官方node_exporter默认使用9100端口
-A INPUT -p tcp -m state --state NEW -m tcp --dport 9100 -j ACCEPT
</code></pre>

<p><strong>5. 验证</strong></p>

<p>访问 <a href="http://10.100.4.181:9090">http://10.100.4.181:9090</a> ，可见node1主机已经可被监控，如下：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245561697241.jpg" alt=""/></p>

<h3 id="toc_10">5. 部署 Grafana</h3>

<p>在 Prometheus&amp; Grafana Server节点部署 Grafana 服务。</p>

<p><strong>1. 下载&amp;安装</strong></p>

<pre><code class="language-bash"># 下载
$ cd /usr/local/src
$ wget https://s3-us-west-2.amazonaws.com/grafana-releases/release/grafana-4.6.2-1.x86_64.rpm

# 安装
$ yum -y localinstall grafana-4.6.2-1.x86_64.rpm
</code></pre>

<p><strong>2. 配置文件</strong></p>

<p>配置文件位于/etc/grafana/grafana.ini，这里暂时保持默认配置即可。</p>

<p><strong>3. 设置开机启动</strong></p>

<pre><code class="language-bash">$ systemctl enable grafana-server
$ systemctl start grafana-server
</code></pre>

<p><strong>4. 设置iptables</strong></p>

<pre><code class="language-bash"># grafana-server默认使用3000端口

-A INPUT -p tcp -m state --state NEW -m tcp --dport 3000 -j ACCEPT
</code></pre>

<p><strong>5. 添加数据源</strong></p>

<p>1）登录</p>

<p>访问：<a href="http://10.100.4.181:3000%EF%BC%8C%E9%BB%98%E8%AE%A4%E8%B4%A6%E5%8F%B7/%E5%AF%86%E7%A0%81%EF%BC%9Aadmin/admin">http://10.100.4.181:3000，默认账号/密码：admin/admin</a></p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245580334189.jpg" alt=""/></p>

<p>2）添加数据源</p>

<p>在登陆首页，点击&quot;Add data source&quot;按钮，跳转到添加数据源页面，配置如下：</p>

<p>Name: prometheus</p>

<p>Type: prometheus</p>

<p>URL: <a href="http://localhost:9090/">http://localhost:9090/</a></p>

<p>Access: proxy</p>

<p>取消Default的勾选，其余默认，点击&quot;Add&quot;，如下：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245583370506.jpg" alt=""/></p>

<p><strong>6. 导入dashboard</strong><br/>
从grafana官网下载相关dashboaed到本地，如：<a href="https://grafana.com/dashboards/1860">https://grafana.com/dashboards/1860</a><br/>
Grafana首页--&gt;左上角图标--&gt;Dashboard--&gt;import</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245585398765.jpg" alt=""/></p>

<p>Upload已下载至本地的json文件（或者使用dashboard id，如这里的1860），如下：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245587856972.jpg" alt=""/></p>

<p>数据源选择&quot;prometheus&quot;，即添加的数据源name，点击&quot;Import&quot;按钮，如下：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245588409973.jpg" alt=""/></p>

<p><strong>7. 查看dashboard</strong><br/>
Grafana首页--&gt;左上角图标--&gt;Dashboard--&gt;Home，Home 下拉列表中可见有已添加的 dashboard  ：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245633321269.jpg" alt=""/></p>

<p>另一个 dashboard 我觉得也不错下载地址 <a href="https://grafana.com/dashboards/159">https://grafana.com/dashboards/159</a> 如下图：</p>

<p><img src="http://p1ly7m2xj.bkt.clouddn.com/15245640521897.jpg" alt=""/></p>

<h3 id="toc_11">参考文档</h3>

<p><a href="https://www.linuxidc.com/Linux/2018-01/150354.htm">https://www.linuxidc.com/Linux/2018-01/150354.htm</a></p>


</div>

<br /><br />
<hr />

<div class="row clearfix">
  <div class="large-6 columns">
	<div class="text-left" style="padding:15px 0px;">
		
	        <a href="15264350522088.html"  title="Previous Post: 运维监控工作规划">&laquo; 运维监控工作规划</a>
	    
	</div>
  </div>
  <div class="large-6 columns">
	<div class="text-right" style="padding:15px 0px;">
		
	        <a href="15258308100903.html" 
	        title="Next Post: 部署 Prometheus 基础环境">部署 Prometheus 基础环境 &raquo;</a>
	    
	</div>
  </div>
</div>

<div class="row">
<div style="padding:0px 0.93em;" class="share-comments">

</div>
</div>
<script type="text/javascript">
	$(function(){
		var currentURL = '15258517853636.html';
		$('#side-nav a').each(function(){
			if($(this).attr('href') == currentURL){
				$(this).parent().addClass('active');
			}
		});
	});
</script>  
</div></div>


<div class="page-bottom">
  <div class="row">
  <hr />
  <div class="small-9 columns">
  <p class="copyright">Copyright &copy; 2015
Powered by <a target="_blank" href="http://www.mweb.im">MWeb</a>,&nbsp; 
Theme used <a target="_blank" href="http://github.com">GitHub CSS</a>.</p>
  </div>
  <div class="small-3 columns">
  <p class="copyright text-right"><a href="#header">TOP</a></p>
  </div>
   
  </div>
</div>

        </section>
      </div>
    </div>
    
    
    <script src="asset/js/foundation.min.js"></script>
    <script src="asset/js/foundation/foundation.offcanvas.js"></script>
    <script>
      $(document).foundation();

     
    </script>
    <script src="asset/chart/all-min.js"></script><script type="text/javascript">$(function(){    var mwebii=0;    var mwebChartEleId = 'mweb-chart-ele-';    $('pre>code').each(function(){        mwebii++;        var eleiid = mwebChartEleId+mwebii;        if($(this).hasClass('language-sequence')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = Diagram.parse($(this).text());            diagram.drawSVG(eleiid,{theme: 'simple'});        }else if($(this).hasClass('language-flow')){            var ele = $(this).addClass('nohighlight').parent();            $('<div id="'+eleiid+'"></div>').insertAfter(ele);            ele.hide();            var diagram = flowchart.parse($(this).text());            diagram.drawSVG(eleiid);        }    });});</script>
<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({TeX: { equationNumbers: { autoNumber: "AMS" } }});</script>

  </body>
</html>
